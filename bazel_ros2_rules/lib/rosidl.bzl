def calculate_rosidl_capitalization(basename):
    """
    Calculate capitalization of files generated by the rosidl pipeline.

    This must match rosidl_cmake.convert_camel_case_to_lower_case_underscore
    https://github.com/ros2/rosidl/blob/7a362b4/rosidl_cmake/rosidl_cmake/__init__.py#L27-L34
    """
    basename_build = []
    alphabet = "abcdefghijklmnopqrstuvwxyz"
    numbers = "0123456789"
    for i in range(len(basename)):
        insert_underscore = False
        if basename[i] in alphabet.upper():
            # insert an underscore before any upper case letter
            # which is followed by a lower case letter
            if i > 0 and i + 1 < len(basename):
                if basename[i + 1] in alphabet.lower():
                    insert_underscore = True

            # insert an underscore before any upper case letter
            # which is preseded by a lower case letter or number
            if i - 1 >= 0:
                if basename[i - 1] in numbers + alphabet.lower():
                    insert_underscore = True
        if insert_underscore:
            basename_build.append("_")
        basename_build.append(basename[i].lower())
    return "".join(basename_build)

def run_calculate_rosidl_capitalization_tests():
    test_cases = [
        ("WSGState", "wsg_state"),
        ("A", "a"),
        ("a", "a"),
        ("_", "_"),
        ("__", "__"),
        ("Accel.msg", "accel.msg"),
        ("AccelStamped.msg", "accel_stamped.msg"),
        ("AccelWithCovariance.msg", "accel_with_covariance.msg"),
        ("AccelWithCovarianceStamped.msg", "accel_with_covariance_stamped.msg"),  # noqa
        ("Arrays.msg", "arrays.msg"),
        ("ArrayVal.msg", "array_val.msg"),
        ("BasicTypes.msg", "basic_types.msg"),
        ("BatteryState.msg", "battery_state.msg"),
        ("Bool.msg", "bool.msg"),
        ("BoundedPlainSequences.msg", "bounded_plain_sequences.msg"),
        ("BoundedSequences.msg", "bounded_sequences.msg"),
        ("Builtins.msg", "builtins.msg"),
        ("Byte.msg", "byte.msg"),
        ("ByteMultiArray.msg", "byte_multi_array.msg"),
        ("CameraInfo.msg", "camera_info.msg"),
        ("ChannelFloat32.msg", "channel_float32.msg"),
        ("Char.msg", "char.msg"),
        ("Clock.msg", "clock.msg"),
        ("Color.msg", "color.msg"),
        ("ColorRGBA.msg", "color_rgba.msg"),
        ("CompressedImage.msg", "compressed_image.msg"),
        ("Constants.msg", "constants.msg"),
        ("Defaults.msg", "defaults.msg"),
        ("DiagnosticArray.msg", "diagnostic_array.msg"),
        ("DiagnosticStatus.msg", "diagnostic_status.msg"),
        ("DisparityImage.msg", "disparity_image.msg"),
        ("DummyMessage.msg", "dummy_message.msg"),
        ("Duration.msg", "duration.msg"),
        ("Empty.msg", "empty.msg"),
        ("FieldsWithSameType.msg", "fields_with_same_type.msg"),
        ("Float32.msg", "float32.msg"),
        ("Float32MultiArray.msg", "float32_multi_array.msg"),
        ("Float64.msg", "float64.msg"),
        ("Float64MultiArray.msg", "float64_multi_array.msg"),
        ("FloatingPointRange.msg", "floating_point_range.msg"),
        ("Floats.msg", "floats.msg"),
        ("FluidPressure.msg", "fluid_pressure.msg"),
        ("Gid.msg", "gid.msg"),
        ("GoalID.msg", "goal_id.msg"),
        ("GoalInfo.msg", "goal_info.msg"),
        ("GoalStatusArray.msg", "goal_status_array.msg"),
        ("GoalStatus.msg", "goal_status.msg"),
        ("GridCells.msg", "grid_cells.msg"),
        ("Header.msg", "header.msg"),
        ("HeaderString.msg", "header_string.msg"),
        ("Illuminance.msg", "illuminance.msg"),
        ("ImageMarker.msg", "image_marker.msg"),
        ("Image.msg", "image.msg"),
        ("Imu.msg", "imu.msg"),
        ("Inertia.msg", "inertia.msg"),
        ("InertiaStamped.msg", "inertia_stamped.msg"),
        ("Int16.msg", "int16.msg"),
        ("Int16MultiArray.msg", "int16_multi_array.msg"),
        ("Int32.msg", "int32.msg"),
        ("Int32MultiArray.msg", "int32_multi_array.msg"),
        ("Int64.msg", "int64.msg"),
        ("Int64MultiArray.msg", "int64_multi_array.msg"),
        ("Int8.msg", "int8.msg"),
        ("Int8MultiArray.msg", "int8_multi_array.msg"),
        ("IntegerRange.msg", "integer_range.msg"),
        ("InteractiveMarkerControl.msg", "interactive_marker_control.msg"),
        ("InteractiveMarkerFeedback.msg", "interactive_marker_feedback.msg"),
        ("InteractiveMarkerInit.msg", "interactive_marker_init.msg"),
        ("InteractiveMarker.msg", "interactive_marker.msg"),
        ("InteractiveMarkerPose.msg", "interactive_marker_pose.msg"),
        ("InteractiveMarkerUpdate.msg", "interactive_marker_update.msg"),
        ("JointCommand.msg", "joint_command.msg"),
        ("JointState.msg", "joint_state.msg"),
        ("JointTrajectory.msg", "joint_trajectory.msg"),
        ("JointTrajectoryPoint.msg", "joint_trajectory_point.msg"),
        ("JoyFeedbackArray.msg", "joy_feedback_array.msg"),
        ("JoyFeedback.msg", "joy_feedback.msg"),
        ("Joy.msg", "joy.msg"),
        ("KeyValue.msg", "key_value.msg"),
        ("LaserEcho.msg", "laser_echo.msg"),
        ("LaserScan.msg", "laser_scan.msg"),
        ("ListParametersResult.msg", "list_parameters_result.msg"),
        ("Log.msg", "log.msg"),
        ("MagneticField.msg", "magnetic_field.msg"),
        ("MapMetaData.msg", "map_meta_data.msg"),
        ("MarkerArray.msg", "marker_array.msg"),
        ("Marker.msg", "marker.msg"),
        ("MenuEntry.msg", "menu_entry.msg"),
        ("MeshFile.msg", "mesh_file.msg"),
        ("Mesh.msg", "mesh.msg"),
        ("MeshTriangle.msg", "mesh_triangle.msg"),
        ("MessageWithHeader.msg", "message_with_header.msg"),
        ("MetricsMessage.msg", "metrics_message.msg"),
        ("MultiArrayDimension.msg", "multi_array_dimension.msg"),
        ("MultiArrayLayout.msg", "multi_array_layout.msg"),
        ("MultiDOFJointState.msg", "multi_dof_joint_state.msg"),
        ("MultiDOFJointTrajectory.msg", "multi_dof_joint_trajectory.msg"),
        ("MultiDOFJointTrajectoryPoint.msg", "multi_dof_joint_trajectory_point.msg"),  # noqa
        ("MultiEchoLaserScan.msg", "multi_echo_laser_scan.msg"),
        ("MultiNested.msg", "multi_nested.msg"),
        ("NavSatFix.msg", "nav_sat_fix.msg"),
        ("NavSatStatus.msg", "nav_sat_status.msg"),
        ("Nested.msg", "nested.msg"),
        ("NodeEntitiesInfo.msg", "node_entities_info.msg"),
        ("OccupancyGrid.msg", "occupancy_grid.msg"),
        ("OccupancyGridUpdate.msg", "occupancy_grid_update.msg"),
        ("Odometry.msg", "odometry.msg"),
        ("ParameterDescriptor.msg", "parameter_descriptor.msg"),
        ("ParameterEventDescriptors.msg", "parameter_event_descriptors.msg"),
        ("ParameterEvent.msg", "parameter_event.msg"),
        ("Parameter.msg", "parameter.msg"),
        ("ParameterType.msg", "parameter_type.msg"),
        ("ParameterValue.msg", "parameter_value.msg"),
        ("ParticipantEntitiesInfo.msg", "participant_entities_info.msg"),
        ("Path.msg", "path.msg"),
        ("Plane.msg", "plane.msg"),
        ("Point32.msg", "point32.msg"),
        ("PointCloud2.msg", "point_cloud2.msg"),
        ("PointCloud2Update.msg", "point_cloud2_update.msg"),
        ("PointCloud.msg", "point_cloud.msg"),
        ("PointField.msg", "point_field.msg"),
        ("Point.msg", "point.msg"),
        ("PointStamped.msg", "point_stamped.msg"),
        ("Polygon.msg", "polygon.msg"),
        ("PolygonStamped.msg", "polygon_stamped.msg"),
        ("Pose2D.msg", "pose2_d.msg"),
        ("PoseArray.msg", "pose_array.msg"),
        ("Pose.msg", "pose.msg"),
        ("PoseStamped.msg", "pose_stamped.msg"),
        ("PoseWithCovariance.msg", "pose_with_covariance.msg"),
        ("PoseWithCovarianceStamped.msg", "pose_with_covariance_stamped.msg"),
        ("ProjectedMapInfo.msg", "projected_map_info.msg"),
        ("ProjectedMap.msg", "projected_map.msg"),
        ("Property.msg", "property.msg"),
        ("Quaternion.msg", "quaternion.msg"),
        ("QuaternionStamped.msg", "quaternion_stamped.msg"),
        ("Range.msg", "range.msg"),
        ("RegionOfInterest.msg", "region_of_interest.msg"),
        ("RelativeHumidity.msg", "relative_humidity.msg"),
        ("RttestResults.msg", "rttest_results.msg"),
        ("SetParametersResult.msg", "set_parameters_result.msg"),
        ("ShortVaried.msg", "short_varied.msg"),
        ("ShortVariedMultiNested.msg", "short_varied_multi_nested.msg"),
        ("ShortVariedNested.msg", "short_varied_nested.msg"),
        ("SolidPrimitive.msg", "solid_primitive.msg"),
        ("State.msg", "state.msg"),
        ("StatisticDataPoint.msg", "statistic_data_point.msg"),
        ("StatisticDataType.msg", "statistic_data_type.msg"),
        ("StringArrays.msg", "string_arrays.msg"),
        ("String.msg", "string.msg"),
        ("Strings.msg", "strings.msg"),
        ("Temperature.msg", "temperature.msg"),
        ("Test.msg", "test.msg"),
        ("TF2Error.msg", "tf2_error.msg"),
        ("TFMessage.msg", "tf_message.msg"),
        ("Time.msg", "time.msg"),
        ("TimeReference.msg", "time_reference.msg"),
        ("Transform.msg", "transform.msg"),
        ("TransformStamped.msg", "transform_stamped.msg"),
        ("TransitionDescription.msg", "transition_description.msg"),
        ("TransitionEvent.msg", "transition_event.msg"),
        ("Transition.msg", "transition.msg"),
        ("Twist.msg", "twist.msg"),
        ("TwistStamped.msg", "twist_stamped.msg"),
        ("TwistWithCovariance.msg", "twist_with_covariance.msg"),
        ("TwistWithCovarianceStamped.msg", "twist_with_covariance_stamped.msg"),  # noqa
        ("UInt16.msg", "u_int16.msg"),
        ("UInt16MultiArray.msg", "u_int16_multi_array.msg"),
        ("UInt32.msg", "u_int32.msg"),
        ("UInt32MultiArray.msg", "u_int32_multi_array.msg"),
        ("UInt64.msg", "u_int64.msg"),
        ("UInt64MultiArray.msg", "u_int64_multi_array.msg"),
        ("UInt8.msg", "u_int8.msg"),
        ("UInt8MultiArray.msg", "u_int8_multi_array.msg"),
        ("UnboundedSequences.msg", "unbounded_sequences.msg"),
        ("UUID.msg", "uuid.msg"),
        ("UVCoordinate.msg", "uv_coordinate.msg"),
        ("Val.msg", "val.msg"),
        ("Vector3.msg", "vector3.msg"),
        ("Vector3Stamped.msg", "vector3_stamped.msg"),
        ("Wrench.msg", "wrench.msg"),
        ("WrenchStamped.msg", "wrench_stamped.msg"),
        ("WString.msg", "w_string.msg"),
        ("WStrings.msg", "w_strings.msg"),
        ("AddDiagnostics.srv", "add_diagnostics.srv"),
        ("AddTwoInts.srv", "add_two_ints.srv"),
        ("Arrays.srv", "arrays.srv"),
        ("BadTwoInts.srv", "bad_two_ints.srv"),
        ("BasicTypes.srv", "basic_types.srv"),
        ("Burst.srv", "burst.srv"),
        ("CancelGoal.srv", "cancel_goal.srv"),
        ("ChangeState.srv", "change_state.srv"),
        ("ConfigLogger.srv", "config_logger.srv"),
        ("DescribeParameters.srv", "describe_parameters.srv"),
        ("Empty.srv", "empty.srv"),
        ("FrameGraph.srv", "frame_graph.srv"),
        ("GetAvailableStates.srv", "get_available_states.srv"),
        ("GetAvailableTransitions.srv", "get_available_transitions.srv"),
        ("GetInteractiveMarkers.srv", "get_interactive_markers.srv"),
        ("GetMapROI.srv", "get_map_roi.srv"),
        ("GetMap.srv", "get_map.srv"),
        ("GetParameters.srv", "get_parameters.srv"),
        ("GetParameterTypes.srv", "get_parameter_types.srv"),
        ("GetPlan.srv", "get_plan.srv"),
        ("GetPointMapROI.srv", "get_point_map_roi.srv"),
        ("GetPointMap.srv", "get_point_map.srv"),
        ("GetPolledImage.srv", "get_polled_image.srv"),
        ("GetRate.srv", "get_rate.srv"),
        ("GetState.srv", "get_state.srv"),
        ("IsPaused.srv", "is_paused.srv"),
        ("Kill.srv", "kill.srv"),
        ("ListNodes.srv", "list_nodes.srv"),
        ("ListParameters.srv", "list_parameters.srv"),
        ("LoadMap.srv", "load_map.srv"),
        ("LoadNode.srv", "load_node.srv"),
        ("Pause.srv", "pause.srv"),
        ("PlayNext.srv", "play_next.srv"),
        ("ProjectedMapsInfo.srv", "projected_maps_info.srv"),
        ("Resume.srv", "resume.srv"),
        ("SaveMap.srv", "save_map.srv"),
        ("Seek.srv", "seek.srv"),
        ("SelfTest.srv", "self_test.srv"),
        ("SetBool.srv", "set_bool.srv"),
        ("SetCameraInfo.srv", "set_camera_info.srv"),
        ("SetMapProjections.srv", "set_map_projections.srv"),
        ("SetMap.srv", "set_map.srv"),
        ("SetParametersAtomically.srv", "set_parameters_atomically.srv"),
        ("SetParameters.srv", "set_parameters.srv"),
        ("SetPen.srv", "set_pen.srv"),
        ("SetRate.srv", "set_rate.srv"),
        ("ShortVariedMultiNested.srv", "short_varied_multi_nested.srv"),
        ("Snapshot.srv", "snapshot.srv"),
        ("Spawn.srv", "spawn.srv"),
        ("TeleportAbsolute.srv", "teleport_absolute.srv"),
        ("TeleportRelative.srv", "teleport_relative.srv"),
        ("Test.srv", "test.srv"),
        ("TogglePaused.srv", "toggle_paused.srv"),
        ("Trigger.srv", "trigger.srv"),
        ("TwoInts.srv", "two_ints.srv"),
        ("UnloadNode.srv", "unload_node.srv"),
        ("Fibonacci.action", "fibonacci.action"),
        ("LookupTransform.action", "lookup_transform.action"),
        ("NestedMessage.action", "nested_message.action"),
        ("RotateAbsolute.action", "rotate_absolute.action"),
        ("ShortVariedMultiNested.action", "short_varied_multi_nested.action"),
        ("Test.action", "test.action"),
    ]
    for idl_name, expected_output in test_cases:
        actual_output = calculate_rosidl_capitalization(idl_name)
        if not expected_output == actual_output:
            fail(msg = "Expected " + expected_output + " got " + actual_output)
